{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Media Details -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <h2 class="card-title">{{ media.title }}</h2>
                        <div class="btn-group">
                            <!-- Post Media Button (pass correct id field by type) -->
                            <a href="{{ url_for('post_routes.create_post', media_type=media_type, media_id=(media.book_id if media_type=='book' else (media.music_id if media_type=='music' else media.cinema_id))) }}" 
                               class="btn btn-info">
                                <i class="fas fa-share"></i> Post Media
                            </a>

                            <!-- Unified Status -->
                            <div class="ms-2">
                                <span class="badge bg-secondary">Status:
                                    {% if user_media %}
                                        {% if user_media.done %} Consumed
                                        {% elif user_media.planned %} Planned
                                        {% else %} Unchecked
                                        {% endif %}
                                    {% else %} Unchecked
                                    {% endif %}
                                </span>
                            </div>

                            {% set current_media_id = media.book_id if media_type=='book' else (media.music_id if media_type=='music' else media.cinema_id) %}
                            {% if user_media and user_media.planned %}
                                <button class="btn btn-warning ms-2" onclick="removeFromPlanner('{{ media.book_id if media_type=='book' else (media.music_id if media_type=='music' else media.cinema_id) }}', '{{ media_type }}')">
                                    <i class="fas fa-calendar-minus"></i> Remove from Planner
                                </button>
                            {% else %}
                                <a class="btn btn-primary ms-2" href="{{ url_for('main_routes.planner') }}?media_type={{ media_type }}&media_id={{ current_media_id }}&media_title={{ media.title|urlencode }}">
                                    <i class="fas fa-calendar-plus"></i> Add to Planner
                                </a>
                            {% endif %}

                            <a class="btn btn-success ms-2" href="{{ url_for('main_routes.diary') }}?media_type={{ media_type }}&media_id={{ current_media_id }}&media_title={{ media.title|urlencode }}">
                                <i class="fas fa-book"></i> Add to Diary
                            </a>
                        </div>
                    </div>
                    
                    <div class="media-details mt-3">
                        {% if media_type == 'book' %}
                            <p><strong>Author:</strong> {{ media.author }}</p>
                            <p><strong>Genre:</strong> {{ media.genre }}</p>
                            <p><strong>Year:</strong> {{ media.year }}</p>
                        {% elif media_type == 'cinema' %}
                            <p><strong>Director:</strong> {{ media.director }}</p>
                            <p><strong>Genre:</strong> {{ media.genre }}</p>
                            <p><strong>Year:</strong> {{ media.year }}</p>
                        {% elif media_type == 'music' %}
                            <p><strong>Artist:</strong> {{ media.artist }}</p>
                            <p><strong>Genre:</strong> {{ media.genre }}</p>
                            <p><strong>Year:</strong> {{ media.year }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if not user_media %}
            <div class="card mt-4">
                <div class="card-header">
                    <h4>Add to Your Library</h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('media_routes.add_to_library') }}">
                        <input type="hidden" name="media_type" value="{{ media_type }}">
                        <input type="hidden" name="media_id" value="{{ media.id }}">
                        
                        <!-- Rating Section -->
                        <div class="mb-3">
                            <label class="form-label">Rating (optional)</label>
                            <div class="rating-input">
                                {% for i in range(1, 6) %}
                                <input type="radio" name="rating" value="{{ i }}" id="star_{{ i }}" class="rating-radio">
                                <label for="star_{{ i }}" class="rating-star">â˜…</label>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Date Consumed -->
                        <div class="mb-3">
                            <label for="date_consumed" class="form-label">Date Consumed (optional)</label>
                            <input type="date" class="form-control" id="date_consumed" name="date_consumed">
                        </div>
                        
                        <button type="submit" class="btn btn-success btn-block w-100">
                            <i class="fas fa-plus"></i> Add to Library
                        </button>
                    </form>
                </div>
            </div>
            {% endif %}

            <!-- Network Activity -->
            <div class="card mt-4">
                <div class="card-header">
                    <h4>Network Activity</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Planned by</h5>
                            <ul class="list-group">
                                {% for user_media_entry in planned_by %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ user_media_entry.user.username if user_media_entry.user else 'Unknown User' }}
                                        <span class="badge bg-primary rounded-pill">{{ user_media_entry.created_at.strftime('%Y-%m-%d') if user_media_entry.created_at else 'Unknown Date' }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5>Consumed by</h5>
                            <ul class="list-group">
                                {% for user_media_entry in consumed_by %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ user_media_entry.user.username if user_media_entry.user else 'Unknown User' }}
                                        <span class="badge bg-success rounded-pill">{{ user_media_entry.date_consumed.strftime('%Y-%m-%d') if user_media_entry.date_consumed else 'Unknown Date' }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Diary Entries -->
            {% if user_media and user_media.done %}
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4>Your Diary</h4>
                    <button class="btn btn-primary" onclick="showAddDiaryModal()">
                        <i class="fas fa-plus"></i> Add Entry
                    </button>
                </div>
                <div class="card-body">
                    {% if user_media.review %}
                    <div class="diary-entry mb-3">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">{{ user_media.date_consumed.strftime('%Y-%m-%d %H:%M') if user_media.date_consumed else 'Unknown Date' }}</small>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" onclick="editDiaryEntry('{{ user_media.user_media_id }}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteDiaryEntry('{{ user_media.user_media_id }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p class="mt-2">{{ user_media.review }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h4>Quick Stats</h4>
                </div>
                <div class="card-body">
                    <p><strong>Planned by:</strong> {{ planned_by|length }} users</p>
                    <p><strong>Consumed by:</strong> {{ consumed_by|length }} users</p>
                    <p><strong>Average Rating:</strong> 
                        {% if user_media and user_media.rating %}
                            {{ user_media.rating|round(1) }}/5
                        {% else %}
                            No ratings yet
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Diary Entry Modal -->
<div class="modal fade" id="diaryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Diary Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="diaryForm">
                    <div class="mb-3">
                        <label for="diaryContent" class="form-label">Your thoughts</label>
                        <textarea class="form-control" id="diaryContent" rows="4" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveDiaryEntry()">Save Entry</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function showAddDiaryModal() {
    const modal = new bootstrap.Modal(document.getElementById('diaryModal'));
    modal.show();
}

function saveDiaryEntry() {
    const content = document.getElementById('diaryContent').value;
    // Add API call to save diary entry
    fetch('/api/diary', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            media_id: '{{ user_media.user_media_id if user_media else "" }}',
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '/diary';
        } else {
            alert('Error saving diary entry');
        }
    });
}

function editDiaryEntry(entryId) {
    // Implement edit functionality
}

function deleteDiaryEntry(entryId) {
    if (confirm('Are you sure you want to delete this entry?')) {
        fetch(`/api/diary/${entryId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting diary entry');
            }
        });
    }
}

function addToPlanner(mediaId, mediaType) {
    fetch(`/api/media/${mediaId}/plan`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            media_type: mediaType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error adding to planner');
        }
    });
}

function removeFromPlanner(mediaId, mediaType) {
    fetch(`/api/media/${mediaId}/remove`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            media_type: mediaType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error removing from planner');
        }
    });
}

function markAsConsumed(mediaId, mediaType) {
    fetch(`/api/media/${mediaId}/consume`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            media_type: mediaType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error marking as consumed');
        }
    });
}
</script>
{% endblock %} 